document.addEventListener('DOMContentLoaded', ()=>{
  const screens    = document.querySelectorAll('.screen');
  const startBtn   = document.getElementById('start-btn');
  const backBtns   = document.querySelectorAll('.back-btn');
  const nextBtn    = document.getElementById('tpl-next-btn');
  const previewBtn = document.getElementById('preview-btn');
  const downloadBtn= document.getElementById('download-btn');
  const tabs       = document.querySelectorAll('.tab-btn');
  let selectedTpl  = 'poster';

  function showScreen(id){
    screens.forEach(s=>s.id===id?s.classList.add('active'):s.classList.remove('active'));
  }

  // 시작
  startBtn.addEventListener('click', ()=> showScreen('template-screen'));
  backBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const cur=document.querySelector('.screen.active').id;
      if(cur==='template-screen') showScreen('main-screen');
      if(cur==='creation-screen') showScreen('template-screen');
      if(cur==='preview-screen') showScreen('creation-screen');
    });
  });

  // 탭 선택
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      selectedTpl = btn.dataset.tpl;
    });
  });

  // 다음 → 커스터마이즈
  nextBtn.addEventListener('click', ()=>{
    showScreen('creation-screen');
  });

  // 미리보기 → 포스터 생성
  previewBtn.addEventListener('click', ()=>{
    showScreen('preview-screen');
    const p = document.getElementById('poster-preview');
    // 입력값 읽기
    const clinic = document.querySelector('[name=clinic]').value;
    const title  = document.querySelector('[name=title]').value;
    const desc   = document.querySelector('[name=desc]').value;
    const period = document.querySelector('[name=period]').value;
    const open   = document.querySelector('[name=openDate]').value;
    const color  = document.querySelector('[name=primaryColor]').value;
    const bgUrl  = document.querySelector('[name=bgUrl]').value;

    // CSS 변수, 이미지, 텍스트 반영
    p.style.setProperty('--primary', color);
    if(bgUrl) p.style.setProperty('--bg-url', `url('${bgUrl}')`);

    p.innerHTML = `
      <div class="bg"></div>
      <div class="content">
        <div class="header">
          <h1>${title}</h1>
          <p>${desc}</p>
        </div>
        <div class="period-box">
          <div class="item">
            <div class="label">휴진기간</div>
            <div class="value">${period}</div>
          </div>
          <div class="item">
            <div class="label">정상진료</div>
            <div class="value">${open}</div>
          </div>
        </div>
        <div class="footer">${clinic}</div>
      </div>
    `;
  });

  // 다운로드
  downloadBtn.addEventListener('click', ()=>{
    const target = document.getElementById('poster-preview');
    html2canvas(target).then(canvas=>{
      const link=document.createElement('a');
      link.download='휴진안내_포스터.png';
      link.href=canvas.toDataURL();
      link.click();
    });
  });

});
